#!/bin/bash
# Add warning headers to generated files in book/ directory
# This prevents accidental editing of generated files

set -e

echo "⚠️  Adding readonly warnings to generated files..."

# Function to add warning to CSS files
add_css_warning() {
    local file="$1"
    local temp_file="${file}.tmp"
    
    # Create warning header
    cat > "$temp_file" << 'EOF'
/* !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 * WARNING: DO NOT EDIT THIS FILE!
 * 
 * This file is GENERATED from: theme/css/
 * Any changes here will be LOST on the next build.
 * 
 * To make changes:
 * 1. Edit the source file in theme/css/
 * 2. Run ./build-all.sh or ./dev-server.sh
 * 
 * This file is in .gitignore and should NEVER be committed.
 * !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! */

EOF
    
    # Append original content
    cat "$file" >> "$temp_file"
    
    # Replace original file
    mv "$temp_file" "$file"
}

# Add warnings to all CSS files in book/theme/css/
if [ -d "book/theme/css" ]; then
    find book/theme/css -name "*.css" -type f | while read -r css_file; do
        # Skip if warning already exists
        if ! grep -q "WARNING: DO NOT EDIT THIS FILE!" "$css_file" 2>/dev/null; then
            add_css_warning "$css_file"
            echo "  Added warning to: $css_file"
        fi
    done
fi

# Add warning to book/custom.css if it exists
if [ -f "book/custom.css" ]; then
    if ! grep -q "WARNING: DO NOT EDIT THIS FILE!" "book/custom.css" 2>/dev/null; then
        # Create a temp file with warning
        temp_file="book/custom.css.tmp"
        cat > "$temp_file" << 'EOF'
/* !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 * WARNING: DO NOT EDIT THIS FILE!
 * 
 * This file is GENERATED from the mdBook build process.
 * It imports theme/css/main.css which contains all styles.
 * 
 * To make CSS changes:
 * 1. Edit files in theme/css/
 * 2. Run ./build-all.sh or ./dev-server.sh
 * 
 * This file is in .gitignore and should NEVER be committed.
 * !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! */

EOF
        cat "book/custom.css" >> "$temp_file"
        mv "$temp_file" "book/custom.css"
        echo "  Added warning to: book/custom.css"
    fi
fi

echo "✅ Warnings added to generated files"