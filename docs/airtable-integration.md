# Airtable Integration Architecture

## Overview

This document describes the integration between the City of Rivergrove mdBook site and the Airtable Public Metadata table. The integration provides enhanced document metadata, human-curated display names, and administrative tracking capabilities.

## Architecture Components

### 1. Data Sources

#### Airtable Public Metadata Table
- **Purpose**: Stores manually curated metadata for all documents
- **Key Fields**:
  - `display_name`: Human-friendly document titles
  - `mdURL`: GitHub URL for markdown files
  - `fileURL`: GitHub URL for PDF files
  - `status`: Publication status (Draft, Published, etc.)
  - `type`: Document type (Ordinance, Resolution, etc.)
  - `year`: Document year
  - `doc_number`: Official document number
  - `short_title`: Brief title for navigation
  - `passed_date`: Date document was passed
  - `digitized`: Whether document has been digitized
  - `special_state`: Special status flags
  - `last_updated`: Last modification timestamp

#### Local relationships.json
- **Purpose**: Auto-generated document relationships and references
- **Generated by**: `scripts/mdbook/generate-relationships.py`
- **Contains**: Document cross-references, amendments, related documents

### 2. Caching Strategy

#### Cache File Location
```
book/airtable-metadata.json
```

#### Cache Structure
```json
{
  "metadata": {
    "last_full_sync": "2024-12-26T10:00:00Z",
    "last_partial_update": "2024-12-26T14:30:00Z",
    "cache_version": "1.1",
    "total_records": 37,
    "incremental_updates": []
  },
  "documents": {
    "2024-Res-#300-Fee-Schedule-Modification": {
      "airtable_id": "recXXXXXX",
      "display_name": "Resolution #300 - Fee Schedule Modification (2024)",
      "status": "Published",
      "tags": ["fees", "administrative"],
      "last_modified": "2024-12-20T..."
    }
  }
}
```

### 3. Sync Modes

#### Full Sync
- **When**: Daily builds, manual refresh
- **Script**: `sync-airtable-metadata.py --mode=full`
- **API Calls**: 1 (fetches all records)
- **Cache Behavior**: Replaces entire cache

#### Incremental Update  
- **When**: Single document processing
- **Script**: `sync-airtable-metadata.py --mode=single --file=<filename>`
- **API Calls**: 1 (fetches single record)
- **Cache Behavior**: Updates single entry, preserves rest

### 4. Integration Points

#### Build Scripts

**./scripts/build/update-mdbook.sh** (Full rebuild)
```bash
echo "ðŸ”— Checking Airtable metadata..."
python3 scripts/mdbook/sync-airtable-metadata.py --mode=full --if-stale
```

**./scripts/build/update-single.sh** (Single document)
```bash
echo "ðŸ”— Updating Airtable metadata for $FILENAME..."
python3 scripts/mdbook/sync-airtable-metadata.py \
    --mode=single \
    --file="$FILENAME" \
    --create-if-missing
```

#### Navigation System
The `navigation-standalone.js` file merges both data sources:
1. Loads `relationships.json` for document structure
2. Loads `airtable-metadata.json` for enhanced metadata
3. Uses filename as linking key between systems
4. Displays Airtable display names when available

### 5. API Call Optimization

| Scenario | API Calls | Frequency |
|----------|-----------|-----------|
| Daily build (cache fresh) | 0 | Most builds |
| Daily build (cache stale) | 1 | Once per 24 hours |
| Single document update | 1 | Per document |
| New document (not in Airtable) | 1 | Graceful fallback |
| Manual force refresh | 1 | On demand |

### 6. Document Linking Strategy

#### Primary Key
Uses GitHub filename (without path) as the linking key between systems.

**Example**:
- File: `/source-documents/Resolutions/2024-Res-#300-Fee-Schedule-Modification.md`
- Key: `2024-Res-#300-Fee-Schedule-Modification`
- Airtable GitHub Path contains: This filename
- Match made on: Extracted filename

#### Fallback Behavior
If document not found in Airtable:
1. Log warning to console
2. Use auto-generated metadata from relationships.json
3. Mark as "provisional" in cache
4. Include in weekly reconciliation report

### 7. Maintenance Tasks

#### Weekly Reconciliation
```bash
./scripts/reconcile-airtable.sh
```
- Forces full sync
- Identifies documents missing from Airtable
- Reports provisional entries
- Cleans incremental update log

#### Manual Cache Clear
```bash
rm book/airtable-metadata.json
./scripts/build/update-mdbook.sh  # Will rebuild cache
```

### 8. Environment Variables

Required for Airtable API access:
```bash
AIRTABLE_API_KEY=your_key_here
AIRTABLE_BASE_ID=your_base_id
AIRTABLE_TABLE_NAME=Public Metadata
```

### 9. Error Handling

#### API Failures
- Uses cached data if available
- Falls back to relationships.json data
- Logs errors but doesn't break build
- Notifies user of degraded functionality

#### Missing Documents
- Creates provisional entry
- Uses auto-generated display name
- Flags for manual review
- Continues build process

### 10. Future Enhancements

1. **Two-way sync**: Push document discoveries back to Airtable
2. **Diff detection**: Only update changed records
3. **Webhook integration**: Real-time updates from Airtable
4. **Status filtering**: Hide drafts from navigation
5. **Tag-based navigation**: Filter by Airtable tags

See [Issue #13](https://github.com/wifelette/city_of_rivergrove/issues/13) for tracking implementation status and additional improvements.

## Monitoring

### Key Metrics
- Cache hit rate (builds without API calls)
- API call volume per day
- Documents missing from Airtable
- Cache age distribution

### Log Locations
- Sync logs: `logs/airtable-sync.log`
- Error logs: `logs/airtable-errors.log`
- Reconciliation reports: `logs/reconciliation/`